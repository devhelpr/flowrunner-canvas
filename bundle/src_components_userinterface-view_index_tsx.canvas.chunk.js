/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(self["flowcanvaswebpackJsonpPlugin"] = self["flowcanvaswebpackJsonpPlugin"] || []).push([["src_components_userinterface-view_index_tsx"],{

/***/ "./src/components/userinterface-view/index.tsx":
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"UserInterfaceView\": () => (/* binding */ UserInterfaceView)\n/* harmony export */ });\n/* harmony import */ var react__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(\"./node_modules/react/index.js\");\n/* harmony import */ var uuid__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(\"./node_modules/uuid/index.js\");\n/* harmony import */ var uuid__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(uuid__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var _devhelpr_layoutrunner__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(\"./node_modules/@devhelpr/layoutrunner/dist/layoutrunner.esm.js\");\n/* harmony import */ var _components_layout_renderer__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(\"./src/components/userinterface-view/components/layout-renderer.tsx\");\n/* harmony import */ var _flow__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(\"./src/components/flow/index.tsx\");\n/* harmony import */ var cross_fetch__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(\"./node_modules/cross-fetch/dist/browser-ponyfill.js\");\n/* harmony import */ var cross_fetch__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(cross_fetch__WEBPACK_IMPORTED_MODULE_5__);\n/* harmony import */ var _state_flow_state__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(\"./src/state/flow-state.ts\");\n/* harmony import */ var _state_layout_state__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(\"./src/state/layout-state.ts\");\n/* harmony import */ var _state_canvas_mode_state__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(\"./src/state/canvas-mode-state.ts\");\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nconst uuidV4 = uuid__WEBPACK_IMPORTED_MODULE_1__.v4;\r\nconst UserInterfaceView = (props) => {\r\n    const [flowName, setFlowName] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [flowHash, setFlowHash] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)({});\r\n    const [titleBarBackgroundcolor, setTitleBarBackgroundcolor] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [titleBarTitle, setTitleBarTitle] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [titleBarColor, setTitleBarColor] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [titleBarFont, setTitleBarFont] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [titleBarFontSize, setTitleBarFontSize] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [titleBarFontWeight, setTitleBarFontWeight] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(\"\");\r\n    const [layoutTree, setLayoutTree] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)({});\r\n    const [isFlowLoaded, setIsFlowLoaded] = (0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(false);\r\n    const unmounted = (0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(false);\r\n    const layoutTreeAsString = (0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(\"\");\r\n    const flow = (0,_state_flow_state__WEBPACK_IMPORTED_MODULE_6__.useFlowStore)();\r\n    const canvasMode = (0,_state_canvas_mode_state__WEBPACK_IMPORTED_MODULE_8__.useCanvasModeStateStore)();\r\n    const layout = (0,_state_layout_state__WEBPACK_IMPORTED_MODULE_7__.useLayoutStore)();\r\n    let nodesStateLocal = (0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)({});\r\n    let touchedNodesLocal = (0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)({});\r\n    const getLayoutNodeFromTree = (level, index, subIndex) => {\r\n        let treeHashKey = level + \".\" + index + \".\" + subIndex;\r\n        if (layoutTreeAsString.current && layoutTreeAsString.current[treeHashKey]) {\r\n            let tree = layoutTreeAsString.current[treeHashKey];\r\n            let layoutTreeNode = [];\r\n            tree.map((layoutBlock, treeIndex) => {\r\n                if (layoutBlock.title == \"element\") {\r\n                    layoutTreeNode.push({\r\n                        type: \"element\",\r\n                        title: layoutBlock.title,\r\n                        subtitle: layoutBlock.subtitle || \"\"\r\n                    });\r\n                }\r\n                else if (layoutBlock.title == \"flowNode\") {\r\n                    layoutTreeNode.push({\r\n                        type: \"flowNode\",\r\n                        title: layoutBlock.title,\r\n                        subtitle: layoutBlock.subtitle || \"\",\r\n                        name: layoutBlock.subtitle || \"\"\r\n                    });\r\n                }\r\n                else if (layoutBlock.title == \"layout2columns\") {\r\n                    layoutTreeNode.push({\r\n                        type: \"layout2columns\",\r\n                        title: layoutBlock.title,\r\n                        layout: [getLayoutNodeFromTree(level + 1, treeIndex, 0),\r\n                            getLayoutNodeFromTree(level + 1, treeIndex, 1),\r\n                        ]\r\n                    });\r\n                }\r\n                else {\r\n                    layoutTreeNode.push({\r\n                        type: \"layout\",\r\n                        title: layoutBlock.title,\r\n                        layout: getLayoutNodeFromTree(level + 1, treeIndex, 0)\r\n                    });\r\n                }\r\n            });\r\n            return layoutTreeNode;\r\n        }\r\n        return [];\r\n    };\r\n    const screenUICallback = (command) => {\r\n        if (command && command.action == \"SendScreen\" && command.payload) {\r\n            const payload = command.payload;\r\n            if (payload.titleBarBackgroundcolor) {\r\n                setTitleBarBackgroundcolor(payload.titleBarBackgroundcolor);\r\n            }\r\n            if (payload.titleBarColor) {\r\n                setTitleBarColor(payload.titleBarColor);\r\n            }\r\n            if (payload.titleBarFont) {\r\n                setTitleBarFont(payload.titleBarFont);\r\n            }\r\n            if (payload.titleBarFontSize) {\r\n                setTitleBarFontSize(payload.titleBarFontSize);\r\n            }\r\n            if (payload.titleBarFontWeight) {\r\n                setTitleBarFontWeight(payload.titleBarFontWeight);\r\n            }\r\n            if (payload.titleBarFontWeight) {\r\n                setTitleBarFontWeight(payload.titleBarFontWeight);\r\n            }\r\n            if (payload.titleBarTitle) {\r\n                setTitleBarTitle(payload.titleBarTitle);\r\n            }\r\n        }\r\n    };\r\n    (0,react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect)(() => {\r\n        if (props.flowrunnerConnector) {\r\n            props.flowrunnerConnector.registerScreenUICallback(screenUICallback);\r\n            props.flowrunnerConnector.unregisterNodeStateObserver(\"canvas\");\r\n            props.flowrunnerConnector.registerNodeStateObserver(\"canvas\", nodeStateObserver);\r\n            const paths = location.pathname.split(\"/\");\r\n            if (props.flowPackage !== undefined && props.flowPackage !== \"\" &&\r\n                props.flowId !== undefined && props.flowId !== \"\") {\r\n                setupFlow(props.flowPackage, props.flowId);\r\n            }\r\n            else if (props.flowrunnerConnector.hasStorageProvider) {\r\n                loadFlow(\"flow\");\r\n            }\r\n            else if (props.flowId !== undefined && props.flowId !== \"\") {\r\n                loadFlow(props.flowId);\r\n            }\r\n            else if (paths.length > 2) {\r\n                if (paths[1] == \"ui\") {\r\n                    const flowId = paths[2];\r\n                    if (flowId !== undefined) {\r\n                        loadFlow(flowId);\r\n                    }\r\n                    else {\r\n                        console.error(\"No flowId specified\");\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return () => {\r\n            unmounted.current = true;\r\n            if (props.flowrunnerConnector) {\r\n                props.flowrunnerConnector.unregisterNodeStateObserver(\"canvas\");\r\n            }\r\n        };\r\n    }, [props.flowrunnerConnector, props.flowId, props.flowPackage]);\r\n    const setupFlow = (flowPackage, flowId) => {\r\n        if (flowPackage.flowType === \"playground\") {\r\n            props.flowrunnerConnector.setFlowType(flowPackage.flowType || \"playground\");\r\n            canvasMode.setFlowrunnerPaused(false);\r\n            canvasMode.setFlowType(flowPackage.flowType || \"playground\");\r\n            flow.storeFlow(flowPackage.flow, flowId);\r\n            layout.storeLayout(JSON.stringify(flowPackage.layout));\r\n            let flowHash = {};\r\n            flowPackage.flow.map((node) => {\r\n                flowHash[node.name] = node;\r\n                return true;\r\n            });\r\n            setFlowName(flowPackage.name);\r\n            setFlowHash(flowHash);\r\n            setIsFlowLoaded(true);\r\n        }\r\n    };\r\n    const loadFlow = (flowId) => {\r\n        var _a;\r\n        if (props.flowrunnerConnector.hasStorageProvider) {\r\n            const flowPackage = (_a = props.flowrunnerConnector.storageProvider) === null || _a === void 0 ? void 0 : _a.getFlow(flowId);\r\n            setupFlow(flowPackage, flowId);\r\n            return;\r\n        }\r\n        cross_fetch__WEBPACK_IMPORTED_MODULE_5___default()('/flowui?flow=' + flowId)\r\n            .then(res => {\r\n            if (res.status >= 400) {\r\n                throw new Error(\"Bad response from server\");\r\n            }\r\n            return res.json();\r\n        })\r\n            .then(flowPackage => {\r\n            setupFlow(flowPackage, flowId);\r\n        })\r\n            .catch(err => {\r\n            console.error(err);\r\n        });\r\n    };\r\n    (0,react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect)(() => {\r\n        layoutTreeAsString.current = JSON.parse(layout.layout) || {};\r\n        setLayoutTree(getLayoutNodeFromTree(1, 0, 0));\r\n        updateTouchedNodes();\r\n    }, [layout, flow]);\r\n    const updateTouchedNodes = () => {\r\n        if (touchedNodesLocal.current) {\r\n            Object.keys(touchedNodesLocal.current).map((touchNodeId) => {\r\n                const element = document.getElementById(touchNodeId);\r\n                if (element) {\r\n                    if (touchedNodesLocal.current[touchNodeId] === true) {\r\n                        element.classList.remove(\"untouched\");\r\n                    }\r\n                    else {\r\n                        element.classList.add(\"untouched\");\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    };\r\n    const nodeStateObserver = (nodeName, nodeState, touchedNodes) => {\r\n        nodesStateLocal.current[nodeName] = nodeState;\r\n        touchedNodesLocal.current = touchedNodes;\r\n        updateTouchedNodes();\r\n    };\r\n    if (!isFlowLoaded) {\r\n        return react__WEBPACK_IMPORTED_MODULE_0__.createElement(react__WEBPACK_IMPORTED_MODULE_0__.Fragment, null);\r\n    }\r\n    let title = flowName || \"UserInterface View\";\r\n    if (titleBarTitle !== \"\") {\r\n        title = titleBarTitle;\r\n    }\r\n    let style = {};\r\n    let navContainerClassName = \"bg-dark mb-4\";\r\n    let navbarClassName = \"navbar navbar-expand-lg navbar-light bg-dark\";\r\n    let h1ClassName = \"text-white\";\r\n    if (titleBarBackgroundcolor) {\r\n        style.backgroundColor = titleBarBackgroundcolor;\r\n        navContainerClassName = \"mb-4\";\r\n        navbarClassName = \"navbar navbar-expand-lg navbar-light\";\r\n    }\r\n    if (titleBarColor) {\r\n        style.color = titleBarColor;\r\n        h1ClassName = \"\";\r\n    }\r\n    if (titleBarFont) {\r\n        style.fontFamily = titleBarFont;\r\n    }\r\n    if (titleBarFontSize) {\r\n        style.fontSize = titleBarFontSize;\r\n    }\r\n    if (titleBarFontWeight) {\r\n        style.fontWeight = titleBarFontWeight;\r\n    }\r\n    return react__WEBPACK_IMPORTED_MODULE_0__.createElement(\"div\", { className: \"pb-4 container__background\" },\r\n        (props.showTitleBar === undefined || props.showTitleBar === true) && react__WEBPACK_IMPORTED_MODULE_0__.createElement(\"div\", { style: style, className: navContainerClassName },\r\n            react__WEBPACK_IMPORTED_MODULE_0__.createElement(\"nav\", { style: style, className: navbarClassName },\r\n                react__WEBPACK_IMPORTED_MODULE_0__.createElement(\"h1\", { className: h1ClassName }, title))),\r\n        react__WEBPACK_IMPORTED_MODULE_0__.createElement(\"div\", { className: \"container container__ui-view\" },\r\n            react__WEBPACK_IMPORTED_MODULE_0__.createElement(_devhelpr_layoutrunner__WEBPACK_IMPORTED_MODULE_2__.Layout, { nodeName: \"ui\", renderLayoutType: _components_layout_renderer__WEBPACK_IMPORTED_MODULE_3__.renderLayoutType, payload: {\r\n                    layout: layoutTree,\r\n                    context: {\r\n                        flowHash: flowHash,\r\n                        flow: flow.flow,\r\n                        getNodeInstance: props.getNodeInstance,\r\n                        flowrunnerConnector: props.flowrunnerConnector,\r\n                        renderHtmlNode: props.renderHtmlNode\r\n                    }\r\n                } })),\r\n        react__WEBPACK_IMPORTED_MODULE_0__.createElement(_flow__WEBPACK_IMPORTED_MODULE_4__.Flow, { flow: flow.flow, flowId: flow.flowId, flowrunnerConnector: props.flowrunnerConnector }));\r\n};\r\n\n\n//# sourceURL=webpack://@devhelpr/flowrunner-canvas/./src/components/userinterface-view/index.tsx?");

/***/ })

}]);